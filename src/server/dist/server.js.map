{"version":3,"file":"server.js","names":["express","morgan","cors","path","fileURLToPath","dirname","apiRouter","config","errorHandler","passport","session","RedisStore","createClient","Strategy","GoogleStrategy","authRouter","googleAuthCallback","serializeUser","deserializeUser","startServer","_ref","_asyncToGenerator","_regeneratorRuntime","mark","_callee","redisUrl","redisClient","app","sessionStore","corsOptions","__filename","__dirname","staticPath","wrap","_callee$","_context","prev","next","process","env","REDISCLOUD_URL","url","console","log","connect","client","use","store","secret","oauth","sessionSecret","resave","saveUninitialized","cookie","secure","httpOnly","sameSite","maxAge","rolling","unset","req","res","initialize","json","origin","CLIENT_URL","credentials","clientID","googleClientId","clientSecret","googleClientSecret","callbackURL","GOOGLE_CALLBACK_URL","import","meta","join","get","sendFile","listen","port","concat","t0","error","stop","apply","arguments"],"sources":["../server.js"],"sourcesContent":["import express from \"express\";\nimport morgan from \"morgan\"; // For logging\nimport cors from \"cors\"; //\nimport path from \"path\";\nimport { fileURLToPath } from \"url\";\nimport { dirname } from \"path\";\nimport apiRouter from \"./routes/index.js\"; // Aggregated routes\nimport config from \"./config/index.js\"; // The config file mysql, port, oauth\nimport { errorHandler } from \"./middlewares/errorHandler.js\";\n//OAuth and Redis\nimport passport from \"passport\"; // From auth.routes\nimport session from \"express-session\"; // Dev & Prod session stors for user info\nimport RedisStore from \"connect-redis\";\nimport { createClient } from \"redis\";\nimport { Strategy as GoogleStrategy } from \"passport-google-oauth20\";\nimport authRouter from \"./routes/auth.routes.js\"; // Import the new auth routes\n// resp from mysqlUrls> promise>query>UserDbTable>output here\nimport {\n  googleAuthCallback,\n  serializeUser,\n  deserializeUser,\n} from \"./controllers/auth.controller.js\";\n\n// Main async function\nconst startServer = async () => {\n  // Determine Redis URL based on environment (dev or prod)\n  const redisUrl = process.env.REDISCLOUD_URL || \"redis://localhost:6379\";\n  const redisClient = createClient({ url: redisUrl });\n\n  console.log(\"server - redisUrl:\", redisUrl);\n  console.log(\"server - redisClient:\", redisClient);\n\n  // Connect to the Redis client\n  try {\n    await redisClient.connect();\n    console.log(\"server - Connected to Redis\");\n\n    // Initialize your Express app here\n    const app = express();\n\n    // Configure the session store\n    const sessionStore = new RedisStore({ client: redisClient });\n    console.log(\"server - sessionStore:\", sessionStore);\n\n    // OAuth session middleware\n    // Has to be at the top, before initalizing Passport and defining any routes\n    app.use(\n      session({\n        store: sessionStore,\n        secret: config.oauth.sessionSecret, // Use session secret from config\n        resave: false,\n        saveUninitialized: true, // Create a seesion for every user that accesse site, even if they haven't auth. \n        // saveUninitialized: false, //recommended, especially if you're concerned about session storage efficiency and want to avoid creating empty sessions.\n        cookie: {\n          secure: false, // Tempararily set to dales for debugging \n          // secure: process.env.NODE_ENV === \"production\", // Set secure to true only in production\n          httpOnly: true, // Recommended for security\n          sameSite: \"lax\", // helps mitigate CSRF attacks by allowing cookies to be sent only in first-party contexts\n          maxAge: 24 * 60 * 60 * 1000, // 1 day (optional, adjust as needed)\n        },\n        rolling: true, // Reset cookie expiration on each request\n        unset: \"destroy\", // Destroy sessions when they are no longer needed\n      })\n    );\n\n    // // Async function to test Redis connection\n    // const testRedisConnection = async () => {\n    //   try {\n    //     await redisClient.set(\"test_key\", \"test_value\");\n    //     const value = await redisClient.get(\"test_key\");\n    //     console.log(`server - Value from Redis: ${value}`); // Should output: test_value\n    //   } catch (error) {\n    //     console.error(\"server - Redis Operation Error\", error);\n    //   }\n    // };\n\n    // // Call the async function\n    // await testRedisConnection();\n\n    //console.loging the session//delete later\n    app.use((req, res, next) => {\n      console.log(\n        \"server - Session before authentication: - delete this console.log later\",\n        {\n          store: sessionStore,\n          session: req.session,\n        }\n      );\n      next();\n    });\n\n    // Initialize Passport Library\n    app.use(passport.initialize());\n    app.use(passport.session());\n\n    // Middleware, Parses inc req and attaches JSON to body parameter of the request object\n    app.use(express.json());\n\n    // CORS is a mechanism that allows restricted resources on a web page to be requested from another domain outside the domain from which the resource originated. By specifying an exact origin, you allow requests only from that domain, while blocking others.\n    // Good for using multi domains\n    const corsOptions = {\n      origin: process.env.CLIENT_URL || \"http://localhost:3000\", // React app URL\n      credentials: true, // Allow credentials to be sent\n    };\n    app.use(cors(corsOptions));\n\n    // Logs incoming request information to the dev console (url, resp, req)\n    app.use(morgan(\"dev\"));\n\n    // Passport configuration for Google OAuth\n    passport.use(\n      new GoogleStrategy(\n        {\n          clientID: config.oauth.googleClientId, //config/index.js\n          clientSecret: config.oauth.googleClientSecret,\n          callbackURL: process.env.GOOGLE_CALLBACK_URL, // Google Callback URL in .env\n        },\n        googleAuthCallback\n      )\n    );\n\n    // Serialize and deserialize user\n    // Add these lines after session middleware and before defining routes\n    passport.serializeUser(serializeUser);\n    passport.deserializeUser(deserializeUser);\n\n    // Define routers\n    app.use(\"/api\", apiRouter);\n    app.use(\"/auth\", authRouter);\n\n    // Serve static files from the React app (front end) __dirname\n    const __filename = fileURLToPath(import.meta.url);\n    const __dirname = dirname(__filename);\n    const staticPath = path.join(__dirname, \"..\", \"../client/build\");\n    console.log(\"server - Serving static files from:\", staticPath);\n    app.use(express.static(staticPath));\n\n    // Handle GET all requests to serve the React app (front end)\n    app.get(\"*\", (req, res) => {\n      res.sendFile(path.join(staticPath, \"index.html\"));\n    });\n\n    // Default Error handler middleware, place code at the bottom\n    app.use(errorHandler);\n\n    // Bind the app to a specified port\n    app.listen(config.port || 8080, () =>\n      console.log(`Server listening on port ${config.port}...`)\n    );\n  } catch (err) {\n    console.error(\"server - Redis Client Connection Error\", err);\n  }\n};\n\n// Start the server\nstartServer();\n"],"mappings":"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","ignoreList":[]}